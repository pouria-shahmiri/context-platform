rules_version = '2'; 
 
 service cloud.firestore { 
   match /databases/{database}/documents { 
     
     // Helper: Check if the user is authenticated and matches the provided userId 
     function isOwner(userId) { 
       return request.auth != null && request.auth.uid == userId; 
     } 
 
     // Helper: Check if the parent document exists and belongs to the user 
     function parentIsOwned(collectionName, docId) { 
       return request.auth != null && 
              exists(/databases/$(database)/documents/$(collectionName)/$(docId)) && 
              get(/databases/$(database)/documents/$(collectionName)/$(docId)).data.userId == request.auth.uid; 
     } 
 
     // Workspaces collection
    match /workspaces/{workspaceId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // Users collection 
    match /users/{userId} { 
       allow read, write: if isOwner(userId); 
 
       // Chat subcollection for Global Chat 
       match /chat/{messageId} { 
         allow read, write: if isOwner(userId); 
       } 
     } 
     
     // Pyramids collection (Root level) 
     match /pyramids/{pyramidId} { 
       // Allow create if the user is authenticated and sets themselves as owner 
       allow create: if isOwner(request.resource.data.userId); 
       
       // Allow read/update/delete if the user owns the document 
       allow read, update, delete: if isOwner(resource.data.userId); 
 
       // Chat subcollection 
       match /chat/{messageId} { 
         allow read, write: if parentIsOwned('pyramids', pyramidId); 
       } 
     } 
     
     // Product Definitions collection 
     match /productDefinitions/{definitionId} { 
       allow create: if isOwner(request.resource.data.userId); 
       allow read, update, delete: if isOwner(resource.data.userId); 
 
       // Chat subcollection for Product Definitions 
       match /chat/{messageId} { 
         allow read, write: if parentIsOwned('productDefinitions', definitionId); 
       } 
     } 
 
     // Independent Conversations collection 
    match /conversations/{conversationId} { 
      allow create: if isOwner(request.resource.data.userId); 
      allow read, update, delete: if isOwner(resource.data.userId); 
      
      // Note: Messages are now embedded as an array field 'messages' within the conversation document.
      // Legacy subcollection support is removed.
    } 

    // Messages collection (Root level for chatService)
    match /messages/{messageId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }
 
    // Context Documents collection 
    match /contextDocuments/{documentId} { 
      allow create: if isOwner(request.resource.data.userId); 
      allow read, update, delete: if isOwner(resource.data.userId); 
    }

    // Directories collection
    match /directories/{directoryId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // Technical Architectures collection
    match /technicalArchitectures/{architectureId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // Technical Tasks collection
    match /technicalTasks/{taskId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // Global Tasks collection
    match /globalTasks/{taskId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // Pipelines collection
    match /pipelines/{pipelineId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    // UI/UX Architectures collection
    match /uiUxArchitectures/{architectureId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }

    match /diagrams/{diagramId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }
  } 
}
